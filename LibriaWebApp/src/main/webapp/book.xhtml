<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/templates/MainTemplate.xhtml">


    <f:metadata>
        <f:viewParam name="isbn" value="#{bookBean.isbn}"/>
        <f:event type="preRenderView" listener="#{bookBean.load}"/>
    </f:metadata>

    <!-- ====== TITRE ONGLET ====== -->
    <ui:define name="title">
        Libria — Livre
    </ui:define>

    <!-- page active dans la navbar -->
    <ui:param name="activePage" value="library"/>

    <!-- ====== CONTENU PRINCIPAL ====== -->
    <ui:define name="content">

        <!-- CSS spécifique à cette page -->
        <style>
            .book-details {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                gap: 2rem;
                align-items: flex-start;
            }

            .book-details .title {
                font-size: 1.6rem;
                font-weight: 600;
                margin-bottom: 0.4rem;
            }

            .book-details .meta {
                font-size: 0.95rem;
                color: #6b7280;
                margin-bottom: 0.2rem;
            }

            .book-details .tag {
                display: inline-block;
                background: #111827;
                color: #e5e7eb;
                padding: 0.15rem 0.6rem;
                border-radius: 999px;
                font-size: 0.8rem;
            }

            .book-details .meta-item {
                display: flex;
                align-items: center;
                gap: 0.3rem;
                margin-top: 0.4rem;
                font-size: 0.9rem;
                color: #fbbf24;
            }

            .book-details .meta-item .meta-text {
                color: #f9fafb;
            }

            .pdf-viewer {
                margin-top: 2rem;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
                border: 1px solid rgba(148, 163, 184, 0.3);
                background: #020617;
            }

            .pdf-viewer object {
                width: 100%;
                height: 600px;
                border: none;
                display: block;
            }

            @media (max-width: 768px) {
                .book-details {
                    flex-direction: column;
                }
                .pdf-viewer object {
                    height: 420px;
                }
            }
        </style>

        <div class="container">
            <h2>Détails du livre</h2>

            <!-- Cas où le livre a été trouvé -->
            <p:panel rendered="#{not empty bookBean.book}">
                <div class="book-details">
                    <div>
                        <div class="title">#{bookBean.book.title}</div>
                        <div class="meta">
                            #{bookBean.book.author} • #{bookBean.book.year}
                        </div>
                        <div class="meta">
                            <span class="tag">#{bookBean.book.genre}</span>
                        </div>
                        <div class="meta">
                            ISBN : #{bookBean.book.isbn}
                        </div>
                        <div class="meta">
                            Disponibilité :
                            #{bookBean.book.available ? 'Disponible' : 'Indisponible'}
                        </div>
                        <div class="meta-item">
                            <i class="fa-solid fa-star star"></i>
                            <span class="meta-text">
                                #{libraryBean.reviewSummary(bookBean.book.isbn)}
                            </span>
                        </div>
                    </div>

                    <h:form>
                        <p:messages/>
                        <p:commandButton value="Télécharger"
                                         icon="pi pi-download"
                                         actionListener="#{bookBean.download}"
                                         update="@form"
                                         disabled="#{!bookBean.book.available}"/>
                    </h:form>
                </div>

                <!-- ====== VIEWER PDF ====== -->
                <ui:fragment rendered="#{not empty bookBean.pdfProxyUrl}">

                    <style>
                        .pdf-section-title {
                            font-size: 1.6rem;
                            font-weight: 700;
                            margin-top: 2rem;
                            margin-bottom: 1rem;
                            color: #0f172a;
                        }

                        .pdf-viewer {
                            margin-top: 1rem;
                            border-radius: 16px;
                            overflow: hidden;
                            border: 1px solid rgba(148, 163, 184, 0.35);
                            background: #0f172a; /* bleu foncé */
                            width: 100%;
                            max-width: 100%;
                            height: 650px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        }

                        .pdf-viewer object {
                            width: 100%;
                            height: 100%;
                            border: none;
                            display: block;
                        }

                        .pdf-fallback {
                            padding: 1rem;
                            font-size: 1rem;
                            color: #e2e8f0;
                        }

                        .pdf-fallback a {
                            color: #3b82f6;
                            text-decoration: underline;
                        }
                    </style>

                    <!-- CONTENU DU VIEWER -->
                    <h3 class="pdf-section-title">Aperçu du PDF</h3>

                    <div class="pdf-viewer">
                        <object
                                data="#{bookBean.pdfProxyUrl}"
                                type="application/pdf">
                            <div class="pdf-fallback">
                                Votre navigateur ne peut pas afficher le PDF.
                                <br/>
                                <h:outputLink value="#{bookBean.pdfUrl}" target="_blank">
                                    ► Ouvrir le PDF dans un nouvel onglet
                                </h:outputLink>
                            </div>
                        </object>
                    </div>

                </ui:fragment>

            </p:panel>

            <!-- Cas où le livre n'existe pas -->
            <p:panel rendered="#{empty bookBean.book}">
                <p:messages/>
                <p>Livre introuvable.</p>
            </p:panel>
        </div>

    </ui:define>
</ui:composition>